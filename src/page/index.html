<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />

    <title>アプリケーションプログラマのための練習プログラム集</title>
  </head>
  <body>
    <!-- ヘッダー -->
    <header class="py-4"></header>
    <!-- /ヘッダー -->
    <div class="container text-center">
      <h1>アプリケーションプログラマのための練習プログラム集</h1>
    </div>
    <!-- ナビゲーションバー -->
    <div id="navbar"></div>
    <!-- /ナビゲーションバー -->
    <!-- メイン -->
    <main>
      <!-- コンテンツ01 -->
      <div class="py-4">
        <section id="app-dev">
          <div class="container">
            <div class="row">
              <h2>TheMoneyExample</h2>
            </div>
            <div class="row p-3">
              <div id="spec"></div>
            </div>
            <div class="row p-3">
              <h2>クラス図</h2>
              <img id="class-im"
              src=http://www.plantuml.com/plantuml/img/SyfFKj2rKt3CoKnELR1Io4ZDoSa70000>
            </div>
          </div>
        </section>

        <div class="py-3">
          <div id="money-app"></div>
        </div>
      </div>
      <!-- /コンテンツ01 -->
    </main>
    <!-- /メイン -->
    <!-- フッター -->
    <div id="footer"></div>
    <!-- /フッター -->
    <div id="dev">
      <section id="mocha"></section>
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"
      ></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"
      ></script>
      <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"
      ></script>
      <!-- PapaParse -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js"></script>

      <!-- nanoSQL2 -->
      <!-- ES6 Only (Faster & Smaller) -->
      <script
        src="https://cdn.jsdelivr.net/npm/@nano-sql/core@2.3.7/dist/nano-sql.min.js"
        integrity="sha256-W1pVgKda7GC4fwXqq9jfOrssBDJJXZqck+ultRPVzmc="
        crossorigin="anonymous"
      ></script>
      <!-- ES5 (Internet Explorer/Old Browser Support) -->
      <!-- Promise must be polyfilled as well -->
      <script
        src="https://cdn.jsdelivr.net/npm/@nano-sql/core@2.3.7/dist/nano-sql.min.es5.js"
        integrity="sha256-1t9VlpFUgHaxlLQy6HM9ROQvTiuUv2M12Fp1oTh3+yg="
        crossorigin="anonymous"
      ></script>

      <!-- markdown -->
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
      <script>
        document.getElementById("spec").innerHTML = marked(
          `
## 仕様

通貨の異なる２つの金額を足し、通貨間の為替レートに基づいて換算された金額を得る。

金額（通貨単位あたりの額）に数値（通貨単位数）を掛け、金額を得る。

## 入力CSVファイル仕様

|銘柄   |株数 |価格  |通貨 |
|:---  |:--- |:--- |:--- |
| string  |  int  | int | string |

## 出力CSVファイル仕様

|銘柄   |株数 |価格  |合計 |
|:---  |:--- |:--- |:--- |
| string  |  int  | int | int |

## ToDoリスト

- [ ] 登録した為替レートを元にレポートを集計する

`
        );
      </script>

      <!-- mermaid -->
      <script
        src="https://unpkg.com/mermaid/dist/mermaid.min.js"
        charset="UTF-8"
      ></script>
      <script>
        mermaid.initialize({
          startOnLoad: true
        });
      </script>

      <!-- PluntUML -->
      <!--  taken from https://github.com/johan/js-deflate -->
      <script src="./lib/rawdeflate.js"></script>
      <script>
        const classDiagram = (() => {
          const inputId = "class-diagram-input";
          const outputId = "class-im";
          const source = `
class Expression {
  times(multiplier)
  plus(addend)
  reduce(bank, to)
}
class Sum {
  augend: Expression
  addend: Expression
  times(multiplier): Expression
  reduce(to): Money
  plus(added): Expression
}
class Bank {
  rates: Map
  reduce(source, to): Money
  addRate(from, to, rate): void
  rate(from, to): int
}
class Pair {
  from: String
  to: String
  equlas(object): boolean
  hashCode(): int
  toString(): String
}
class Money {
  amount: int
  currency() :String
  times(multiplier) :Money
  plus(addend) :Expression
  equals(object) :boolean
  reduce(to) :Money
  {static} dollar(amount): Dollar
  {static} franc(amount): Franc
}
class ExChangeRate {
  from: String
  to: String
  rate: float
  id: int
}
class ReportViewModel {
  title: String
  sum: int
  currenty: String
  items<ReportViewModelItem>: List
  total(): Sum
}
class ReportViewModelItem {
  stockName: String
  stockAmount: int
  price: Money
  sum: Money
}
class ExChangeRateViewModel {
  record: List<ExChangeRate>
}
class MoneyService {
  setupDb(): void
  createReportViewModel(data): RepositoryViewModel
  addExChangeRate(): ExChangeRateViewModel
  selectAllExChangeRate(): ExChangeRateViewModel
  updateExChangeRate(id):  ExChangeRateViewModel
  deleteExChangeRate(id): ExChangeRateViewModel
  deleteAllExChangeRate(): ExChangeRateViewModel
  saveReport(): void
  getReport(): ReportViewModle
  deleteReport(): void
}
class ReportRepository {
  db: String
  table: String
  setup(): void
  connect(): void
  get(): ReporViewModel
  save(): void
  destroy(): void
}
class ExChangeRateRepository {
  db: String
  table: String
  setup(): void
  connect(): void
  create(): ExChangeRate
  createBatch(): List<ExChangeRate>
  save(): ExChangeRate
  find(): ExChangeRate
  seletAll(): List<ExChangeRate>
  delete(): void
  destroy(): void
}
class View {
  REPORT: 1
  EXCHANGE: 2
  _service: MoneyService
  _report: ReportViewModel
  _exChangeRate: ExChangeRateViewModel
  _selectTab: int
  dispatchEvent(): void
  render(): void
}
Expression <|.. Money
Expression <|.. Sum
Money <- Sum
Sum <- Bank
Bank -> Pair
Bank <-- ReportViewModel
Sum <-- ReportViewModel
Money <-- ReportViewModelItem
ExChangeRate --o ExChangeRateViewModel
ExChangeRateViewModel <-- MoneyService
ExChangeRate <- ExChangeRateRepository
ReportRepository -o MoneyService
ReportViewModel <- ReportRepository
MoneyService o- ExChangeRateRepository
ReportViewModelItem -o ReportViewModel
ReportViewModel <-- MoneyService
MoneyService --o View
ReportViewModel --o View
ExChangeRateViewModel --o View
          `;
          compress(source, outputId);
        })();

        function encode64(data) {
          r = "";
          for (i = 0; i < data.length; i += 3) {
            if (i + 2 == data.length) {
              r += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), 0);
            } else if (i + 1 == data.length) {
              r += append3bytes(data.charCodeAt(i), 0, 0);
            } else {
              r += append3bytes(
                data.charCodeAt(i),
                data.charCodeAt(i + 1),
                data.charCodeAt(i + 2)
              );
            }
          }
          return r;
        }

        function append3bytes(b1, b2, b3) {
          c1 = b1 >> 2;
          c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
          c3 = ((b2 & 0xf) << 2) | (b3 >> 6);
          c4 = b3 & 0x3f;
          r = "";
          r += encode6bit(c1 & 0x3f);
          r += encode6bit(c2 & 0x3f);
          r += encode6bit(c3 & 0x3f);
          r += encode6bit(c4 & 0x3f);
          return r;
        }

        function encode6bit(b) {
          if (b < 10) {
            return String.fromCharCode(48 + b);
          }
          b -= 10;
          if (b < 26) {
            return String.fromCharCode(65 + b);
          }
          b -= 26;
          if (b < 26) {
            return String.fromCharCode(97 + b);
          }
          b -= 26;
          if (b == 0) {
            return "-";
          }
          if (b == 1) {
            return "_";
          }
          return "?";
        }

        var deflater = window.SharedWorker && new SharedWorker("rawdeflate.js");
        if (deflater) {
          deflater.port.addEventListener("message", done_deflating, false);
          deflater.port.start();
        } else if (window.Worker) {
          deflater = new Worker("rawdeflate.js");
          deflater.onmessage = done_deflating;
        }

        function done_deflating(e, id) {
          document.getElementById(id).src =
            "http://www.plantuml.com/plantuml/img/" + encode64(e.data);
        }

        function compress(s, id) {
          //UTF8
          s = unescape(encodeURIComponent(s));

          if (deflater) {
            if (deflater.port && deflater.port.postMessage) {
              deflater.port.postMessage(s);
            } else {
              deflater.postMessage(s);
            }
          } else {
            setTimeout(function() {
              done_deflating({ data: deflate(s) }, id);
            }, 100);
          }
        }
      </script>

      <!-- mocha, chai -->
      <script src="https://cdn.rawgit.com/mochajs/mocha/2.2.5/mocha.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js"></script>
      <script>
        mocha.setup("tdd");
      </script>
      <script>
        const assert = chai.assert;
        suite("MoneyTest", () => {
          test("Multiplication", () => {
            const five = Money.dollar(5);
            assert.isOk(Money.dollar(10).equals(five.times(2)));
            assert.isOk(Money.dollar(15).equals(five.times(3)));
          });

          test("Equality", () => {
            assert.isOk(Money.dollar(5).equals(Money.dollar(5)));
            assert.isNotOk(Money.dollar(5).equals(Money.dollar(6)));
            assert.isNotOk(Money.franc(5).equals(Money.dollar(5)));
          });

          test("Currency", () => {
            assert.equal("USD", Money.dollar(1).currency());
            assert.equal("CHF", Money.franc(1).currency());
          });

          test("SimpleAddition", () => {
            const five = Money.dollar(5);
            const sum = five.plus(five);
            const bank = new Bank();
            const reduced = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(10).equals(reduced));
          });

          test("PlusReturnsSum", () => {
            const five = Money.dollar(5);
            const result = five.plus(five);
            const sum = result;
            assert.isOk(five.equals(sum.augend));
            assert.isOk(five.equals(sum.addend));
          });

          test("ReduceSum", () => {
            const sum = new Sum(Money.dollar(3), Money.dollar(4));
            const bank = new Bank();
            const result = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(7).equals(result));
          });

          test("ReduceMoney", () => {
            const bank = new Bank();
            const result = bank.reduce(Money.dollar(1), "USD");
            assert.isOk(Money.dollar(1).equals(result));
          });

          test("ReduceMoneyDifferentCurrency()", () => {
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const result = bank.reduce(Money.franc(2), "USD");
            assert.isOk(Money.dollar(1).equals(result));
          });

          test("MixedAddition", () => {
            const fiveBucks = Money.dollar(5);
            const tenFrancs = Money.franc(10);
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const result = bank.reduce(fiveBucks.plus(tenFrancs), "USD");
            assert.isOk(Money.dollar(10).equals(result));
          });

          test("SumPlusMoney", () => {
            const fiveBucks = Money.dollar(5);
            const tenFrancs = Money.franc(10);
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const sum = new Sum(fiveBucks, tenFrancs).plus(fiveBucks);
            const result = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(15).equals(result));
          });

          test("SumTimes", () => {
            const fiveBucks = Money.dollar(5);
            const tenFrancs = Money.franc(10);
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const sum = new Sum(fiveBucks, tenFrancs).times(2);
            const result = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(20).equals(result));
          });
        });

        suite("ExChangeRepositoryTest", () => {
          let repository;
          setup(() => {
            repository = new ExChangeRateRepository(
              "money_test",
              "exchange_rates"
            );
          });

          test("Setup", () => {
            return repository.setup().then(result => {
              const dbList = nSQL().listDatabases();
              assert.equal("money_test", dbList[1]);
            });
          });

          test("Create", () => {
            const entitiy = new ExChangeRate("CHF", "USD", 1.5);

            return repository.connect().then(() => {
              return repository.create(entitiy).then(() => {
                return repository.selectAll().then(result => {
                  assert.isOk(result[0].id);
                  assert.equal(result[0].from, entitiy.from);
                  assert.equal(result[0].to, entitiy.to);
                  assert.equal(result[0].rate, entitiy.rate);
                });
              });
            });
          });

          test("Update", () => {
            const entitiy = new ExChangeRate("CHF", "USD", 1.5);

            return repository.connect().then(() => {
              return repository.create(entitiy).then(result => {
                const id = result.id;
                const updateEntity = new ExChangeRate("USD", "CHF", 3.0, id);
                return repository.save(updateEntity).then(() => {
                  return repository.find(id).then(result => {
                    assert.equal(id, result.id);
                    assert.equal("USD", result.from);
                    assert.equal("CHF", result.to);
                    assert.equal(3, result.rate);
                  });
                });
              });
            });
          });

          test("Delete", () => {
            const entitiy = new ExChangeRate("CHF", "USD", 1.5);

            return repository.connect().then(() => {
              return repository.create(entitiy).then(() => {
                return repository.selectAll().then(result => {
                  const id = result[0].id;
                  return repository.delete(id).then(result => {
                    repository.find(id).then(result => {
                      assert.deepEqual([], result);
                    });
                  });
                });
              });
            });
          });

          test("DeleteAll", () => {
            const entitiy1 = new ExChangeRate("CHF", "USD", 1.5);
            const entitiy2 = new ExChangeRate("CHF", "USD", 2.0);

            return repository.connect().then(() => {
              return repository.createBatch([entitiy1, entitiy2]).then(() => {
                return repository.destroy().then(() => {
                  return repository.selectAll().then(result => {
                    assert.equal(0, result.length);
                  });
                });
              });
            });
          });
        });

        suite("ReportRepositoryTest", () => {
          let repository;
          setup(() => {
            repository = new ReportRepository("money_test", "report");
          });

          test("Setup", () => {
            return repository.setup().then(result => {
              const dbList = nSQL().listDatabases();
              assert.equal("money_test", dbList[1]);
            });
          });

          test("Create", () => {
            const data = [
              { 銘柄: "IBM", 株数: "1000", 価格: "25", 通貨: "USD" },
              { 銘柄: "Novartis", 株数: "400", 価格: "150", 通貨: "CHF" }
            ];
            const items = data.map(
              i =>
                new ReportViewModelItem(
                  i.銘柄,
                  i.株数,
                  new Money(i.価格, i.通貨)
                )
            );
            const report = new ReportViewModel(items);

            return repository.save(report).then(() => {
              return repository.get().then(result => {
                assert.equal("Money Report", result.title);
                assert.equal(65000, result.sum);
                assert.equal("USD", result.currency);
              });
            });
          });

          test("Destroy", () => {
            return repository.destroy();
          });
        });

        suite("MoneyServiceTest", () => {
          let service;
          setup(() => {
            service = new MoneyService();
          });

          test("GetReport", () => {
            const data = [
              { 銘柄: "IBM", 株数: "1000", 価格: "25", 通貨: "USD" },
              { 銘柄: "Novartis", 株数: "400", 価格: "150", 通貨: "CHF" }
            ];
            const items = data.map(
              i =>
                new ReportViewModelItem(
                  i.銘柄,
                  i.株数,
                  new Money(i.価格, i.通貨)
                )
            );
            const report = new ReportViewModel(items);

            return service.deleteReport().then(() => {
              return service.saveReport(report).then(() => {
                return service.getReport().then(result => {
                  assert.equal("Money Report", result.title);
                });
              });
            });
          });

          test("DeleteReport", () => {
            return service.deleteReport();
          });
        });

        class Pair {
          constructor(from, to) {
            this._from = from;
            this._to = to;
          }

          get from() {
            return this._from;
          }

          get to() {
            return this._to;
          }

          equals(object) {
            const pair = object;
            return this._from === pair.from && this._to === pair.to;
          }

          toString() {
            return `${this._from}-${this._to}`;
          }

          hashCode() {
            return 0;
          }
        }

        class Expression {
          times(multiplier) {}
          plus(added) {}
          reduce(bank, to) {}
        }

        class Sum extends Expression {
          constructor(augend, addend) {
            super();
            this._augend = augend;
            this._addend = addend;
          }
          get augend() {
            return this._augend;
          }

          get addend() {
            return this._addend;
          }

          times(multiplier) {
            return new Sum(
              this._augend.times(multiplier),
              this._augend.times(multiplier)
            );
          }

          plus(addend) {
            return new Sum(this, addend);
          }

          reduce(bank, to) {
            const amount =
              this._augend.reduce(bank, to).amount +
              this._addend.reduce(bank, to).amount;
            return new Money(amount, to);
          }
        }

        class Bank {
          constructor() {
            this._rates = new Map();
          }

          reduce(source, to) {
            return source.reduce(this, to);
          }

          addRate(from, to, rate) {
            this._rates.set(new Pair(from, to).toString(), rate);
          }

          rate(from, to) {
            if (from === to) return 1;
            return this._rates.get(new Pair(from, to).toString());
          }
        }

        class Money extends Expression {
          constructor(amount, currency) {
            super();
            this._amount = amount;
            this._currency = currency;
          }

          get amount() {
            return this._amount;
          }

          times(multiplier) {
            return new Money(this._amount * multiplier, this._currency);
          }

          plus(addend) {
            return new Sum(this, addend);
          }

          reduce(bank, to) {
            const rate = bank.rate(this._currency, to);
            return new Money(this._amount / rate, to);
          }

          currency() {
            return this._currency;
          }

          equals(object) {
            const money = object;
            return (
              this._amount === money._amount &&
              this._currency === money._currency
            );
          }

          toString() {
            return this._amount + " " + this._currency;
          }

          static dollar(amount) {
            return new Money(amount, "USD");
          }

          static franc(amount) {
            return new Money(amount, "CHF");
          }
        }

        class ReportViewModel {
          constructor(
            items,
            title = "Money Report",
            sum = 0,
            currency = "USD"
          ) {
            this._items = items;
            this._title = title;
            this._sum = sum;
            this._currency = currency;
            this._bank = new Bank();
            this._bank.addRate("CHF", "USD", 1.5);
          }
          get title() {
            return this._title;
          }
          get sum() {
            return this._sum;
          }
          get currency() {
            return this._currency;
          }
          get items() {
            return this._items;
          }
          get total() {
            let result = new Money(0, "USD");
            this._items.forEach(i => {
              result = this._bank.reduce(new Sum(result, i.sum), "USD");
            });
            return result;
          }
        }

        class ReportViewModelItem {
          constructor(stockName, stockAmount, price) {
            this._stockName = stockName;
            this._stockAmount = stockAmount;
            this._price = price;
            this._sum = price.times(stockAmount);
          }
          get stockName() {
            return this._stockName;
          }
          get stockAmount() {
            return this._stockAmount;
          }
          get price() {
            return this._price;
          }
          get sum() {
            return this._sum;
          }
        }

        class ExChangeRateViewModel {
          constructor(exChangeRateRecord) {
            this._record = exChangeRateRecord;
          }

          get record() {
            return this._record;
          }
        }

        class ExChangeRate {
          constructor(from, to, rate, id) {
            this._from = from;
            this._to = to;
            this._rate = rate;
            this._id = id;
          }

          get id() {
            return this._id;
          }

          get from() {
            return this._from;
          }

          get to() {
            return this._to;
          }

          get rate() {
            return this._rate;
          }
        }

        class ReportRepository {
          constructor(db, table) {
            this._db = db;
            this._table = table;
          }

          get db() {
            return this._db;
          }
          get table() {
            return this._table;
          }

          setup() {
            return new Promise((resolve, reject) => {
              const dbList = nSQL().listDatabases();
              if (dbList.includes(this.db)) return resolve();

              // Persistent Database
              nSQL()
                .createDatabase({
                  id: this.db,
                  mode: "PERM",
                  tables: [
                    {
                      name: "report",
                      model: {
                        "title:string": {},
                        "total:obj": {},
                        "items:obj[]": { default: [] }
                      },
                      indexes: {}
                    },
                    {
                      name: "exchange_rates",
                      model: {
                        "id:uuid": { pk: true },
                        "from:string": {},
                        "to:string": {},
                        "rate:float:": {}
                      },
                      indexes: {}
                    }
                  ]
                })
                .then(() => {
                  return resolve();
                })
                .catch(() => {
                  return reject();
                });
            });
          }

          connect() {
            return new Promise((resolve, reject) => {
              nSQL().useDatabase(this.db);
              resolve();
            });
          }

          save(data) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .exec()
                .then(() => {
                  nSQL(this.table)
                    .query("upsert", data)
                    .exec()
                    .then(rows => {
                      return resolve(rows);
                    })
                    .catch(err => {
                      return reject(err);
                    });
                });
            });
          }

          get() {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("select")
                .exec()
                .then(rows => {
                  if (rows.length === 0)
                    return resolve(new ReportViewModel([]));

                  const result = rows.map(
                    row =>
                      new ReportViewModel(
                        row.items,
                        row.title,
                        row.total._amount,
                        row.total._currency
                      )
                  )[0];
                  return resolve(result);
                })
                .catch(err => {
                  return reject(err);
                });
            });
          }

          destroy() {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .exec()
                .then(() => {
                  return resolve();
                })
                .catch(err => {
                  return reject(err);
                });
            });
          }
        }

        class ExChangeRateRepository {
          constructor(db, table) {
            this._db = db;
            this._table = table;
          }

          get db() {
            return this._db;
          }

          get table() {
            return this._table;
          }

          setup() {
            return new Promise((resolve, reject) => {
              const dbList = nSQL().listDatabases();
              if (dbList.includes(this.db)) return resolve();

              // Persistent Database
              nSQL()
                .createDatabase({
                  id: this.db,
                  mode: "PERM",
                  tables: [
                    {
                      name: "report",
                      model: {
                        "title:string": {},
                        "total:obj": {},
                        "items:obj[]": { default: [] }
                      },
                      indexes: {}
                    },
                    {
                      name: "exchange_rates",
                      model: {
                        "id:uuid": { pk: true },
                        "from:string": {},
                        "to:string": {},
                        "rate:float:": {}
                      },
                      indexes: {}
                    }
                  ]
                })
                .then(() => {
                  return resolve();
                })
                .catch(() => {
                  return reject();
                });
            });
          }

          connect() {
            return new Promise((resolve, reject) => {
              nSQL().useDatabase(this.db);
              resolve();
            });
          }

          create(data) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("upsert", data)
                .exec()
                .then(rows => {
                  return resolve(
                    rows.map(
                      row =>
                        new ExChangeRate(row.from, row.to, row.rate, row.id)
                    )[0]
                  );
                })
                .catch(err => {
                  return reject(err);
                });
            });
          }

          save(data) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .where(["id", "=", data.id])
                .exec()
                .then(rows => {
                  return resolve(
                    nSQL(this.table)
                      .query("upsert", data)
                      .exec()
                      .then(rows => {
                        return resolve(
                          rows.map(
                            row =>
                              new ExChangeRate(
                                row.from,
                                row.to,
                                row.rate,
                                row.id
                              )
                          )[0]
                        );
                      })
                      .catch(() => {
                        return reject();
                      })
                  );
                })
                .catch(err => {
                  return reject(err);
                });
            });
          }

          selectAll() {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("select")
                .exec()
                .then(rows => {
                  const result = rows.map(
                    row => new ExChangeRate(row.from, row.to, row.rate, row.id)
                  );
                  return resolve(result);
                })
                .catch(err => {
                  return reject(err);
                });
            });
          }

          delete(id) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .where(["id", "=", id])
                .exec()
                .then(rows => {
                  return resolve();
                })
                .catch(err => {
                  return reject(err);
                });
            });
          }

          find(id) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("select")
                .where(["id", "=", id])
                .exec()
                .then(rows => {
                  if (rows.length === 0) {
                    return resolve([]);
                  } else {
                    return resolve(
                      new ExChangeRate(
                        rows[0].from,
                        rows[0].to,
                        rows[0].rate,
                        rows[0].id
                      )
                    );
                  }
                })
                .catch(err => {
                  return reject(err);
                });
            });
          }

          createBatch(list) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("upsert", list)
                .exec()
                .then(rows => {
                  return resolve(
                    rows.map(
                      row =>
                        new ExChangeRate(row.from, row.to, row.rate, row.id)
                    )
                  );
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          destroy() {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .exec()
                .then(() => {
                  resolve();
                })
                .catch(err => {
                  reject(err);
                });
            });
          }
        }

        class MoneyService {
          constructor() {
            this._reportRepository = new ReportRepository("money", "report");
            this._exChangeRateRepository = new ExChangeRateRepository(
              "money",
              "exchange_rates"
            );
          }

          createReportViewModel(data) {
            const items = data.map(
              i =>
                new ReportViewModelItem(
                  i.銘柄,
                  i.株数,
                  new Money(i.価格, i.通貨)
                )
            );
            return new ReportViewModel(items);
          }

          saveReport(report) {
            return new Promise((resolve, reject) => {
              this._reportRepository.save(report).then(() => {
                resolve();
              });
            });
          }

          getReport() {
            return new Promise((resolve, reject) => {
              this._reportRepository.get().then(result => {
                const items = result.items.map(
                  i =>
                    new ReportViewModelItem(
                      i._stockName,
                      i._stockAmount,
                      new Money(i._price._amount, i._price._currency)
                    )
                );
                return resolve(new ReportViewModel(items));
              });
            });
          }

          deleteReport() {
            return new Promise((resolve, reject) => {
              this._reportRepository.destroy().then(() => {
                return resolve();
              });
            });
          }

          setUpDb() {
            return new Promise((resolve, reject) => {
              const dbList = nSQL().listDatabases();
              if (dbList.length > 0) resolve();

              this._reportRepository
                .setup()
                .then(() => {
                  this._exChangeRateRepository
                    .setup()
                    .then(() => {
                      resolve();
                    })
                    .catch(err => {
                      reject(err);
                    });
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          selectAllExChangeRate() {
            return new Promise((resolve, reject) => {
              this._exChangeRateRepository
                .connect()
                .then(() => {
                  this._exChangeRateRepository
                    .selectAll()
                    .then(result => {
                      return resolve(new ExChangeRateViewModel(result));
                    })
                    .catch(err => {
                      reject(err);
                    });
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          updateExChangeRate(from, to, rate, id) {
            return new Promise((resolve, reject) => {
              const entity = new ExChangeRate(from, to, rate, id);
              return this._exChangeRateRepository.save(entity).then(() => {
                return this._exChangeRateRepository.selectAll().then(result => {
                  return resolve(new ExChangeRateViewModel(result));
                });
              });
            });
          }

          addExChangeRate() {
            return new Promise((resolve, reject) => {
              const entity = new ExChangeRate("CHF", "USD", 1.5);

              return this._exChangeRateRepository.create(entity).then(() => {
                return this._exChangeRateRepository.selectAll().then(result => {
                  return resolve(new ExChangeRateViewModel(result));
                });
              });
            });
          }

          deleteExChangeRate(id) {
            return new Promise((resolve, reject) => {
              this._exChangeRateRepository.delete(id).then(() => {
                this._exChangeRateRepository.selectAll().then(result => {
                  return resolve(new ExChangeRateViewModel(result));
                });
              });
            });
          }

          deleteAllExChangeRate() {
            return new Promise((resolve, reject) => {
              this._exChangeRateRepository.destroy().then(() => {
                this._exChangeRateRepository.selectAll().then(result => {
                  return resolve(new ExChangeRateViewModel(result));
                });
              });
            });
          }
        }

        class View {
          constructor() {
            this.REPORT = 1;
            this.EXCHANGE = 2;

            this._service = new MoneyService();
            this._selectTab = this.REPORT;
          }

          dispatchEvent() {
            const uploadEvent = e => {
              if (
                window.File &&
                window.FileReader &&
                window.FileList &&
                window.Blob
              ) {
                const fileData = e.target.files[0];

                if (!fileData.name.match(".csv$")) {
                  alert("CSVファイルを選択してください");
                  return;
                }

                const reader = new FileReader();

                reader.onload = () => {
                  const data = reader.result;
                  const parseData = Papa.parse(data, {
                    header: true,
                    skipEmptyLines: true
                  });

                  const report = this._service.createReportViewModel(
                    parseData.data
                  );

                  this._service.saveReport(report).then(() => {
                    this._selectTab = this.REPORT;
                    this.render();
                  });
                };

                reader.readAsText(fileData, "utf-8");
              } else {
                alert("File APIに対応したブラウザでご確認ください");
              }
            };

            const downloadEvent = e => {
              const csv = Papa.unparse(this._report.items);
              const bom = new Uint8Array([0xef, 0xbb, 0xbf]);
              const blog = new Blob([bom, csv], { type: "text/csv" });
              const url = URL.createObjectURL(blog);
              const a = document.createElement("a");

              a.href = url;
              a.target = "_blank";
              a.download = "data.csv";

              a.click();
            };

            const addExChangeRateEvent = e => {
              this._service.addExChangeRate().then(data => {
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            const editExChangeRateEvent = e => {
              e.target.disabled = true;
              e.target.parentElement.getElementsByTagName(
                "button"
              )[1].disabled = false;

              const from = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "td"
              )[1];
              const to = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "td"
              )[2];
              const rate = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "td"
              )[3];

              from.innerHTML = `<input type="text" size="10" value=${from.innerText}>`;
              to.innerHTML = `<input type="text" size="10" value=${to.innerText}>`;
              rate.innerHTML = `<input type="text" size="10" value=${rate.innerText}>`;
            };

            const saveExChangeRateEvent = e => {
              const from = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[0];
              const to = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[1];
              const rate = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[2];
              const id = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[3].value;

              this._service
                .updateExChangeRate(from.value, to.value, rate.value, id)
                .then(result => {
                  this._selectTab = this.EXCHANGE;
                  this.render();
                });
            };

            const deleteAllExChangeRateEvent = e => {
              this._service.deleteAllExChangeRate().then(() => {
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            const delteExhangeRateEvent = e => {
              const id = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[0].value;

              this._service.deleteExChangeRate(id).then(() => {
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            const selectReportTabEvent = e => {
              this._service.getReport().then(result => {
                this._selectTab = this.REPORT;
                this.render();
              });
            };

            const selectExChangeRateTabEvent = e => {
              this._service.selectAllExChangeRate().then(result => {
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            document
              .querySelector("#app-money-upload")
              .addEventListener("change", uploadEvent);
            document
              .querySelector("#app-money-download")
              .addEventListener("click", downloadEvent);
            document
              .querySelector("#button-add")
              .addEventListener("click", addExChangeRateEvent);
            document
              .querySelector("#button-delete")
              .addEventListener("click", deleteAllExChangeRateEvent);
            this._exChangeRate.record.forEach((v, k) => {
              document
                .querySelector(`#button-edit-${k}`)
                .addEventListener("click", editExChangeRateEvent);
              document
                .querySelector(`#button-save-${k}`)
                .addEventListener("click", saveExChangeRateEvent);
              document.querySelector(`#button-save-${k}`).disabled = true;
              document
                .querySelector(`#button-delete-${k}`)
                .addEventListener("click", delteExhangeRateEvent);
            });
            document
              .querySelector("#tab-menu01")
              .addEventListener("click", selectReportTabEvent);
            document
              .querySelector("#tab-menu02")
              .addEventListener("click", selectExChangeRateTabEvent);
          }

          render() {
            const reportSelect =
              this._selectTab === this.REPORT ? "active" : "";
            const exChangeSelect =
              this._selectTab === this.EXCHANGE ? "active" : "";

            const tabNav = `
                      <div class="nav nav-tabs" id="tab-menus" role="tablist">
                        <a
                          aria-controls="panel-menu01"
                          aria-selected="true"
                          class="nav-item nav-link ${reportSelect}"
                          data-toggle="tab"
                          href="#panel-menu01"
                          id="tab-menu01"
                          role="tab"
                          >レポート</a
                        >
                        <a
                          aria-controls="panel-menu02"
                          aria-selected="false"
                          class="nav-item nav-link ${exChangeSelect}"
                          data-toggle="tab"
                          href="#panel-menu02"
                          id="tab-menu02"
                          role="tab"
                          >為替レート</a
                        >
                      </div>
                  `;

            const tabContent = exChangeRateRecord => {
              const report = () => {
                const activeShow = reportSelect ? "active show" : "";

                const table = () => {
                  const header = () => {
                    const line = ["銘柄", "株数", "価格", "合計"]
                      .map(i => `<th>${i}</th>`)
                      .join(" ");

                    return `
                                  <thead>
                                    <tr>
                                      ${line}
                                    </tr>
                                  </thead>
                            `;
                  };

                  const body = () => {
                    const items = this._report.items;
                    const line = items
                      .map(
                        i => `
                            <tr>
                              <td>${i.stockName}</td>
                              <td>${i.stockAmount}</td>
                              <td>${i.price}</td>
                              <td>${i.sum}</td>
                            </tr>
                            `
                      )
                      .join(" ");
                    const total = `
                                    <tr>
                                      <td></td>
                                      <td></td>
                                      <td>
                                        <p>総計</p>
                                      </td>
                                      <td>
                                        <p>${this._report.total}</p>
                                      </td>
                                    </tr>
                            `;
                    return `
                                  <tbody>
                                    ${line}
                                    ${total}
                                  </tbody>
                            `;
                  };

                  return `
                                <table id="report-table" class="table table-striped">
                                    ${header()}
                                    ${body()}
                                </table>
                          `;
                };

                const upload = () => {
                  return `
                                <div class="col-md-12">
                                  <form>
                                    <div class="form-group">
                                      <p>
                                        CSVファイルを選択して下さい。<br />
                                      </p>
                                      <input
                                        type="file"
                                        class="form-control-file"
                                        id="app-money-upload"
                                      />
                                    </div>
                                  </form>
                                </div>
                          `;
                };

                const download = () => {
                  return `
                                <button
                                  type="button"
                                  class="btn btn-primary btn"
                                  id="app-money-download"
                                >
                                  CSVダウンロード
                                </button>
                          `;
                };

                return `
                        <div
                          aria-labelledby="tab-menu01"
                          class="tab-pane fade border border-top-0 ${activeShow}"
                          id="panel-menu01"
                          role="tabpanel"
                        >
                          <dvi class="row p-3">
                            <div id="report" class="col-md-12 order-md-2">
                              <div class="row">
                                ${upload()}
                              </div>
                              <div class="row">
                                ${table()}
                              </div>
                              <div class="col-md-12 py-2">
                                ${download()}
                              </div>
                            </div>
                          </dvi>
                        </div>
                    `;
              };

              const exChangeRate = record => {
                const activeShow = exChangeSelect ? "active show" : "";

                const table = record => {
                  const header = () => {
                    const th = ["ID", "換算元", "換算先", "レート", ""]
                      .map(i => `<th>${i}</th>`)
                      .join(" ");

                    return `
                                <thead>
                                  <tr>
                                    ${th}
                                  </tr>
                                </thead>
                            `;
                  };

                  const body = () => {
                    const line = (item, key) => {
                      const edit = () => {
                        return `
                                        <button
                                          id="button-edit-${key}"
                                          type="button"
                                          class="btn btn-primary btn-rounded btn-sm my-0 waves-effect waves-light"
                                        >
                                          編集
                                        </button>
                              `;
                      };

                      const save = () => {
                        return `
                                        <button
                                          id="button-save-${key}"
                                          type="button"
                                          class="btn btn-primary btn-rounded btn-sm my-0 waves-effect waves-light"
                                        >
                                          保存
                                        </button>
                              `;
                      };

                      const delet = () => {
                        return `
                                        <button
                                          id="button-delete-${key}"
                                          type="button"
                                          class="btn btn-danger btn-rounded btn-sm my-0 waves-effect waves-light"
                                        >
                                          削除
                                        </button>
                              `;
                      };

                      return `
                                  <tr>
                                    <td>${item.id.slice(0, 5)}...</td>
                                    <td>${item.from}</td>
                                    <td>${item.to}</td>
                                    <td>${item.rate}</td>
                                    <td>
                                      <span class="button">
                                        ${edit()}
                                        ${save()}
                                        ${delet()}
                                      </span>
                                    </td>
                                    <td>
                                      <input type="hidden" value=${item.id}>
                                    </td>
                                  </tr>
                              `;
                    };

                    return `
                                <tbody>
                                  ${record.map((v, k) => line(v, k)).join("")}
                                </tbody>
                            `;
                  };

                  return `
                              <table
                                id="exchange-rate-table"
                                class="table table-striped"
                              >
                                ${header()}
                                ${body()}
                              </table>
                          `;
                };

                const button = () => {
                  const add = () => {
                    return `
                                <button
                                  id="button-add"
                                  type="button"
                                  class="btn btn-primary btn-rounded btn-sm my-0"
                                >
                                  追加
                                </button>
                            `;
                  };

                  const deletAll = () => {
                    return `
                                <button
                                  id="button-delete"
                                  type="button"
                                  class="btn btn-danger btn-rounded btn-sm my-0"
                                >
                                  全削除
                                </button>
                            `;
                  };
                  return `
                              <div id="button">
                                ${add()}
                                ${deletAll()}
                              </div>
                          `;
                };

                return `
                        <div
                          aria-labelledby="tab-menu02"
                          class="tab-pane fade border border-top-0 ${activeShow}"
                          id="panel-menu02"
                          role="tabpanel"
                        >
                          <dvi class="row p-3">
                            <div id="exchange-rate" class="col-md-12 order-md-2">
                              ${table(record)}
                              ${button()}
                            </div>
                          </dvi>
                        </div>
                    `;
              };

              return `
              <div class="tab-content" id="panel-menus">
                ${report()}
                ${exChangeRate(exChangeRateRecord)}
              </div>
              `;
            };

            this._service.setUpDb().then(() => {
              this._service.getReport().then(data => {
                this._report = data;
                this._service.selectAllExChangeRate().then(data => {
                  this._exChangeRate = data;
                  const content = tabContent(this._exChangeRate.record);
                  const result = `
                      <section id="menu">
                        <div class="container">
                          <div id="message"></div>
                          ${tabNav}
                          ${tabContent(this._exChangeRate.record)}
                        </div>
                      </section>
                    `;

                  document.querySelector("#money-app").innerHTML = result;
                  this.dispatchEvent();
                });
              });
            });
          }
        }

        const view = new View();
        view.render();
      </script>
      <script>
        mocha.globals(["jQuery"]);
        mocha.run();
      </script>
    </div>
  </body>
</html>
