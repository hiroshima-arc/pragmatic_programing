<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />

    <title>アプリケーションプログラマのための練習プログラム集</title>
  </head>
  <body>
    <!-- ヘッダー -->
    <header class="py-4"></header>
    <!-- /ヘッダー -->
    <div class="container text-center">
      <h1>アプリケーションプログラマのための</h1>
      <h1>練習プログラム集</h1>
    </div>
    <!-- ナビゲーションバー -->
    <div id="navbar"></div>
    <!-- /ナビゲーションバー -->
    <!-- メイン -->
    <main>
      <!-- コンテンツ01 -->
      <div class="py-4">
        <section id="app-dev">
          <div class="container">
            <div class="row">
              <h2>TheMoneyExample</h2>
            </div>
            <div class="row p-3">
              <div id="spec"></div>
            </div>
            <div class="row p-3">
              <h2>クラス図</h2>
              <img id="class-im"
              src=http://www.plantuml.com/plantuml/img/SyfFKj2rKt3CoKnELR1Io4ZDoSa70000>
            </div>
          </div>
        </section>

        <div class="py-3">
          <div id="money-app"></div>
        </div>
      </div>
      <!-- /コンテンツ01 -->
    </main>
    <!-- /メイン -->
    <!-- フッター -->
    <div id="footer"></div>
    <!-- /フッター -->
    <div id="dev">
      <section id="mocha"></section>
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"
      ></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"
      ></script>
      <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"
      ></script>
      <!-- PapaParse -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js"></script>

      <!-- nanoSQL2 -->
      <!-- ES6 Only (Faster & Smaller) -->
      <script
        src="https://cdn.jsdelivr.net/npm/@nano-sql/core@2.3.7/dist/nano-sql.min.js"
        integrity="sha256-W1pVgKda7GC4fwXqq9jfOrssBDJJXZqck+ultRPVzmc="
        crossorigin="anonymous"
      ></script>
      <!-- ES5 (Internet Explorer/Old Browser Support) -->
      <!-- Promise must be polyfilled as well -->
      <script
        src="https://cdn.jsdelivr.net/npm/@nano-sql/core@2.3.7/dist/nano-sql.min.es5.js"
        integrity="sha256-1t9VlpFUgHaxlLQy6HM9ROQvTiuUv2M12Fp1oTh3+yg="
        crossorigin="anonymous"
      ></script>

      <!-- markdown -->
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
      <script src="./lib/markdown.js"></script>

      <!-- mermaid -->
      <script
        src="https://unpkg.com/mermaid/dist/mermaid.min.js"
        charset="UTF-8"
      ></script>
      <script src="./lib/marmaid.js"></script>

      <!-- PluntUML -->
      <!--  taken from https://github.com/johan/js-deflate -->
      <script src="./lib/rawdeflate.js"></script>
      <script src="./lib/pluntuml.js"></script>

      <!-- mocha, chai -->
      <script src="https://cdn.rawgit.com/mochajs/mocha/2.2.5/mocha.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js"></script>
      <script>
        mocha.setup("tdd");
      </script>
      <script>
        const assert = chai.assert;
        suite("MoneyTest", () => {
          test("Multiplication", () => {
            const five = Money.dollar(5);
            assert.isOk(Money.dollar(10).equals(five.times(2)));
            assert.isOk(Money.dollar(15).equals(five.times(3)));
          });

          test("Equality", () => {
            assert.isOk(Money.dollar(5).equals(Money.dollar(5)));
            assert.isNotOk(Money.dollar(5).equals(Money.dollar(6)));
            assert.isNotOk(Money.franc(5).equals(Money.dollar(5)));
          });

          test("Currency", () => {
            assert.equal("USD", Money.dollar(1).currency());
            assert.equal("CHF", Money.franc(1).currency());
          });

          test("SimpleAddition", () => {
            const five = Money.dollar(5);
            const sum = five.plus(five);
            const bank = new Bank();
            const reduced = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(10).equals(reduced));
          });

          test("PlusReturnsSum", () => {
            const five = Money.dollar(5);
            const result = five.plus(five);
            const sum = result;
            assert.isOk(five.equals(sum.augend));
            assert.isOk(five.equals(sum.addend));
          });

          test("ReduceSum", () => {
            const sum = new Sum(Money.dollar(3), Money.dollar(4));
            const bank = new Bank();
            const result = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(7).equals(result));
          });

          test("ReduceMoney", () => {
            const bank = new Bank();
            const result = bank.reduce(Money.dollar(1), "USD");
            assert.isOk(Money.dollar(1).equals(result));
          });

          test("ReduceMoneyDifferentCurrency()", () => {
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const result = bank.reduce(Money.franc(2), "USD");
            assert.isOk(Money.dollar(1).equals(result));
          });

          test("MixedAddition", () => {
            const fiveBucks = Money.dollar(5);
            const tenFrancs = Money.franc(10);
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const result = bank.reduce(fiveBucks.plus(tenFrancs), "USD");
            assert.isOk(Money.dollar(10).equals(result));
          });

          test("SumPlusMoney", () => {
            const fiveBucks = Money.dollar(5);
            const tenFrancs = Money.franc(10);
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const sum = new Sum(fiveBucks, tenFrancs).plus(fiveBucks);
            const result = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(15).equals(result));
          });

          test("SumTimes", () => {
            const fiveBucks = Money.dollar(5);
            const tenFrancs = Money.franc(10);
            const bank = new Bank();
            bank.addRate("CHF", "USD", 2);
            const sum = new Sum(fiveBucks, tenFrancs).times(2);
            const result = bank.reduce(sum, "USD");
            assert.isOk(Money.dollar(20).equals(result));
          });
        });

        suite("ExChangeRepositoryTest", () => {
          let repository;
          setup(() => {
            const db = new MoneyDB("money_test", "TEMP");
            repository = new ExChangeRateRepository(db, MoneyDB.EXCHANGE_RATES);
          });

          test("Setup", () => {
            return repository.setup().then(result => {
              const dbList = nSQL().listDatabases();
              assert.equal("money_test", dbList[1]);
            });
          });

          test("Create", () => {
            const entitiy = new ExChangeRate("CHF", "USD", 1.5);

            return repository.connect().then(() => {
              return repository.create(entitiy).then(() => {
                return repository.selectAll().then(result => {
                  assert.isOk(result[0].id);
                  assert.equal(result[0].from, entitiy.from);
                  assert.equal(result[0].to, entitiy.to);
                  assert.equal(result[0].rate, entitiy.rate);
                });
              });
            });
          });

          test("Update", () => {
            const entitiy = new ExChangeRate("CHF", "USD", 1.5);

            return repository.connect().then(() => {
              return repository.create(entitiy).then(result => {
                const id = result.id;
                const updateEntity = new ExChangeRate("USD", "CHF", 3.0, id);
                return repository.save(updateEntity).then(() => {
                  return repository.find(id).then(result => {
                    assert.equal(id, result.id);
                    assert.equal("USD", result.from);
                    assert.equal("CHF", result.to);
                    assert.equal(3, result.rate);
                  });
                });
              });
            });
          });

          test("Delete", () => {
            const entitiy = new ExChangeRate("CHF", "USD", 1.5);

            return repository.connect().then(() => {
              return repository.create(entitiy).then(() => {
                return repository.selectAll().then(result => {
                  const id = result[0].id;
                  return repository.delete(id).then(result => {
                    repository.find(id).then(result => {
                      assert.deepEqual([], result);
                    });
                  });
                });
              });
            });
          });

          test("DeleteAll", () => {
            const entitiy1 = new ExChangeRate("CHF", "USD", 1.5);
            const entitiy2 = new ExChangeRate("CHF", "USD", 2.0);

            return repository.connect().then(() => {
              return repository.createBatch([entitiy1, entitiy2]).then(() => {
                return repository.destroy().then(() => {
                  return repository.selectAll().then(result => {
                    assert.equal(0, result.length);
                  });
                });
              });
            });
          });
        });

        suite("ReportRepositoryTest", () => {
          let repository;
          setup(() => {
            const db = new MoneyDB("money_test", "TEMP");
            repository = new ReportRepository(db, MoneyDB.REPORT);
          });

          test("Setup", () => {
            return repository.setup().then(result => {
              const dbList = nSQL().listDatabases();
              assert.equal("money_test", dbList[1]);
            });
          });

          test("Create", () => {
            const data = [
              { 銘柄: "IBM", 株数: "1000", 価格: "25", 通貨: "USD" },
              { 銘柄: "Novartis", 株数: "400", 価格: "150", 通貨: "CHF" }
            ];
            const items = data.map(
              i => new ReportLineItem(i.銘柄, i.株数, new Money(i.価格, i.通貨))
            );
            const bank = new Bank();
            bank.addRate("CHF", "USD", 1.5);
            const report = new Report(items, bank);

            return repository.save(report).then(() => {
              return repository.get().then(result => {
                assert.equal("Money Report", result.title);
                assert.equal(65000, result.sum);
                assert.equal("USD", result.currency);
              });
            });
          });

          test("Destroy", () => {
            return repository.destroy();
          });
        });

        suite("MoneyServiceTest", () => {
          let service;
          let bank;
          setup(() => {
            service = new MoneyServiceMock();
          });

          test("GetReport", () => {
            const data = [
              { 銘柄: "IBM", 株数: "1000", 価格: "25", 通貨: "USD" },
              { 銘柄: "Novartis", 株数: "400", 価格: "150", 通貨: "CHF" }
            ];

            return service.deleteReport().then(() => {
              return service.createReportViewModel(data).then(report => {
                return service.saveReport(report).then(() => {
                  return service.getReport().then(result => {
                    assert.equal("Money Report", result.title);
                  });
                });
              });
            });
          });

          test("CreateReport", () => {
            const entitiy = new ExChangeRate("CHF", "USD", 2);
            const data = [
              { 銘柄: "Novartis", 株数: "1", 価格: "150", 通貨: "CHF" }
            ];

            return service.addExChangeRate(entitiy).then(() => {
              return service.createReportViewModel(data).then(report => {
                return service.saveReport(report).then(() => {
                  return service.getReport().then(result => {
                    assert.equal("75 USD", result.total.toString());
                  });
                });
              });
            });
          });

          test("DeleteReport", () => {
            return service.deleteReport();
          });

          test("DeleteExChangeRate", () => {
            return service.deleteAllExChangeRate();
          });
        });

        class Pair {
          constructor(from, to) {
            this._from = from;
            this._to = to;
          }

          get from() {
            return this._from;
          }

          get to() {
            return this._to;
          }

          equals(object) {
            const pair = object;
            return this._from === pair.from && this._to === pair.to;
          }

          toString() {
            return `${this._from}-${this._to}`;
          }

          hashCode() {
            return 0;
          }
        }

        class Expression {
          times(multiplier) {}
          plus(added) {}
          reduce(bank, to) {}
        }

        class Sum extends Expression {
          constructor(augend, addend) {
            super();
            this._augend = augend;
            this._addend = addend;
          }
          get augend() {
            return this._augend;
          }

          get addend() {
            return this._addend;
          }

          times(multiplier) {
            return new Sum(
              this._augend.times(multiplier),
              this._augend.times(multiplier)
            );
          }

          plus(addend) {
            return new Sum(this, addend);
          }

          reduce(bank, to) {
            const amount =
              this._augend.reduce(bank, to).amount +
              this._addend.reduce(bank, to).amount;
            return new Money(amount, to);
          }
        }

        class Bank {
          constructor() {
            this._rates = new Map();
          }

          reduce(source, to) {
            return source.reduce(this, to);
          }

          addRate(from, to, rate) {
            this._rates.set(new Pair(from, to).toString(), rate);
          }

          rate(from, to) {
            if (from === to) return 1;
            return this._rates.get(new Pair(from, to).toString());
          }
        }

        class Money extends Expression {
          constructor(amount, currency) {
            super();
            this._amount = amount;
            this._currency = currency;
          }

          get amount() {
            return this._amount;
          }

          times(multiplier) {
            return new Money(this._amount * multiplier, this._currency);
          }

          plus(addend) {
            return new Sum(this, addend);
          }

          reduce(bank, to) {
            const rate = bank.rate(this._currency, to);
            return new Money(this._amount / rate, to);
          }

          currency() {
            return this._currency;
          }

          equals(object) {
            const money = object;
            return (
              this._amount === money._amount &&
              this._currency === money._currency
            );
          }

          toString() {
            return this._amount + " " + this._currency;
          }

          static dollar(amount) {
            return new Money(amount, "USD");
          }

          static franc(amount) {
            return new Money(amount, "CHF");
          }
        }

        class Report {
          constructor(
            items,
            bank,
            title = "Money Report",
            sum = 0,
            currency = "USD"
          ) {
            this._items = items;
            this._title = title;
            this._sum = sum;
            this._currency = currency;
            this._bank = bank;
          }
          get title() {
            return this._title;
          }
          get sum() {
            return this._sum;
          }
          get currency() {
            return this._currency;
          }
          get items() {
            return this._items;
          }
          get total() {
            let result = new Money(0, "USD");
            this._items.forEach(i => {
              result = this._bank.reduce(new Sum(result, i.sum), "USD");
            });
            return result;
          }
        }

        class ReportLineItem {
          constructor(stockName, stockAmount, price) {
            this._stockName = stockName;
            this._stockAmount = stockAmount;
            this._price = price;
            this._sum = price.times(stockAmount);
          }
          get stockName() {
            return this._stockName;
          }
          get stockAmount() {
            return this._stockAmount;
          }
          get price() {
            return this._price;
          }
          get sum() {
            return this._sum;
          }
        }

        class ExChangeRates {
          constructor(exChangeRateRecord) {
            this._record = exChangeRateRecord;
          }

          get record() {
            return this._record;
          }
        }

        class ExChangeRate {
          constructor(from, to, rate, id) {
            this._from = from;
            this._to = to;
            this._rate = rate;
            this._id = id;
          }

          get id() {
            return this._id;
          }

          get from() {
            return this._from;
          }

          get to() {
            return this._to;
          }

          get rate() {
            return this._rate;
          }
        }

        class MoneyDB {
          constructor(name, mode = "PERM") {
            this._name = name;
            this._mode = mode;
          }

          static get REPORT() {
            return "report";
          }

          static get EXCHANGE_RATES() {
            return "exchange_rates";
          }

          setup() {
            return new Promise((resolve, reject) => {
              const dbList = nSQL().listDatabases();
              if (dbList.includes(this._name)) return resolve();

              nSQL()
                .createDatabase({
                  id: this._name,
                  mode: this._mode,
                  tables: [
                    {
                      name: MoneyDB.REPORT,
                      model: {
                        "title:string": {},
                        "total:obj": {},
                        "items:obj[]": { default: [] }
                      },
                      indexes: {}
                    },
                    {
                      name: MoneyDB.EXCHANGE_RATES,
                      model: {
                        "id:uuid": { pk: true },
                        "from:string": {},
                        "to:string": {},
                        "rate:float:": {}
                      },
                      indexes: {}
                    }
                  ]
                })
                .then(() => {
                  resolve();
                })
                .catch(() => {
                  reject();
                });
            });
          }

          connect() {
            return new Promise((resolve, reject) => {
              nSQL().useDatabase(this._name);
              resolve();
            });
          }
        }

        class ReportRepository {
          constructor(db, table) {
            this._db = db;
            this._table = table;
          }

          get table() {
            return this._table;
          }

          setup() {
            return new Promise((resolve, reject) => {
              resolve(this._db.setup());
            });
          }

          connect() {
            return new Promise((resolve, reject) => {
              resolve(this._db.connect());
            });
          }

          save(data) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .exec()
                .then(() => {
                  nSQL(this.table)
                    .query("upsert", data)
                    .exec()
                    .then(rows => {
                      resolve(rows);
                    })
                    .catch(err => {
                      reject(err);
                    });
                });
            });
          }

          get() {
            return new Promise((resolve, reject) => {
              const bank = new Bank();
              bank.addRate("CHF", "USD", 1.5);

              nSQL(this.table)
                .query("select")
                .exec()
                .then(rows => {
                  if (rows.length === 0) return resolve(new Report([], bank));

                  const result = rows.map(
                    row =>
                      new Report(
                        row.items,
                        bank,
                        row.title,
                        row.total._amount,
                        row.total._currency
                      )
                  )[0];
                  resolve(result);
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          destroy() {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .exec()
                .then(() => {
                  resolve();
                })
                .catch(err => {
                  reject(err);
                });
            });
          }
        }

        class ExChangeRateRepository {
          constructor(db, table) {
            this._db = db;
            this._table = table;
          }

          get table() {
            return this._table;
          }

          setup() {
            return new Promise((resolve, reject) => {
              resolve(this._db.setup());
            });
          }

          connect() {
            return new Promise((resolve, reject) => {
              resolve(this._db.connect());
            });
          }

          create(data) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("upsert", data)
                .exec()
                .then(rows => {
                  resolve(
                    rows.map(
                      row =>
                        new ExChangeRate(row.from, row.to, row.rate, row.id)
                    )[0]
                  );
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          save(data) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .where(["id", "=", data.id])
                .exec()
                .then(rows => {
                  resolve(
                    nSQL(this.table)
                      .query("upsert", data)
                      .exec()
                      .then(rows => {
                        resolve(
                          rows.map(
                            row =>
                              new ExChangeRate(
                                row.from,
                                row.to,
                                row.rate,
                                row.id
                              )
                          )[0]
                        );
                      })
                      .catch(() => {
                        reject();
                      })
                  );
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          selectAll() {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("select")
                .exec()
                .then(rows => {
                  const result = rows.map(
                    row => new ExChangeRate(row.from, row.to, row.rate, row.id)
                  );
                  resolve(result);
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          delete(id) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .where(["id", "=", id])
                .exec()
                .then(rows => {
                  resolve();
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          find(id) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("select")
                .where(["id", "=", id])
                .exec()
                .then(rows => {
                  if (rows.length === 0) {
                    resolve([]);
                  } else {
                    resolve(
                      new ExChangeRate(
                        rows[0].from,
                        rows[0].to,
                        rows[0].rate,
                        rows[0].id
                      )
                    );
                  }
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          createBatch(list) {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("upsert", list)
                .exec()
                .then(rows => {
                  resolve(
                    rows.map(
                      row =>
                        new ExChangeRate(row.from, row.to, row.rate, row.id)
                    )
                  );
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          destroy() {
            return new Promise((resolve, reject) => {
              nSQL(this.table)
                .query("delete")
                .exec()
                .then(() => {
                  resolve();
                })
                .catch(err => {
                  reject(err);
                });
            });
          }
        }

        class MoneyService {
          constructor() {
            const db = new MoneyDB("money");
            this._reportService = new ReportService(db);
            this._exChangeRateService = new ExChangeRateService(db);
          }

          setUpDb() {
            return new Promise((resolve, reject) => {
              const dbList = nSQL().listDatabases();
              if (dbList.length > 0) resolve();

              this._reportService.repository
                .setup()
                .then(() => {
                  this._exChangeRateService.repository
                    .setup()
                    .then(() => {
                      resolve();
                    })
                    .catch(err => {
                      reject(err);
                    });
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          createReportViewModel(data) {
            return new Promise((resolve, reject) => {
              this._exChangeRateService.selectAllExChangeRate().then(result => {
                resolve(
                  this._reportService.createReportViewModel(data, result.record)
                );
              });
            });
          }

          saveReport(report) {
            return new Promise((resolve, reject) => {
              this._reportService.saveReport(report).then(() => {
                resolve();
              });
            });
          }

          getReport() {
            return new Promise((resolve, reject) => {
              this._exChangeRateService.selectAllExChangeRate().then(result => {
                resolve(this._reportService.getReport(result.record));
              });
            });
          }

          deleteReport() {
            return new Promise((resolve, reject) => {
              this._reportService.deleteReport().then(() => {
                resolve();
              });
            });
          }

          selectAllExChangeRate() {
            return new Promise((resolve, reject) => {
              resolve(this._exChangeRateService.selectAllExChangeRate());
            });
          }

          updateExChangeRate(from, to, rate, id) {
            return new Promise((resolve, reject) => {
              resolve(
                this._exChangeRateService.updateExChangeRate(from, to, rate, id)
              );
            });
          }

          addExChangeRate(entity = new ExChangeRate("CHF", "USD", 1.5)) {
            return new Promise((resolve, reject) => {
              resolve(this._exChangeRateService.addExChangeRate(entity));
            });
          }

          deleteExChangeRate(id) {
            return new Promise((resolve, reject) => {
              resolve(this._exChangeRateService.deleteExChangeRate(id));
            });
          }

          deleteAllExChangeRate() {
            return new Promise((resolve, reject) => {
              resolve(this._exChangeRateService.deleteAllExChangeRate());
            });
          }
        }

        class ReportService {
          constructor(db) {
            this._repository = new ReportRepository(db, "report");
          }

          get repository() {
            return this._repository;
          }

          createReportViewModel(data, rates) {
            return new Promise((resolve, reject) => {
              const bank = new Bank();
              rates.map(i => bank.addRate(i.from, i.to, i.rate));

              const items = data.map(
                i =>
                  new ReportLineItem(i.銘柄, i.株数, new Money(i.価格, i.通貨))
              );

              return resolve(new Report(items, bank));
            });
          }

          saveReport(report) {
            return new Promise((resolve, reject) => {
              this._repository.save(report).then(() => {
                resolve();
              });
            });
          }

          getReport(rates) {
            return new Promise((resolve, reject) => {
              const bank = new Bank();
              rates.map(i => bank.addRate(i.from, i.to, i.rate));

              this._repository.get().then(result => {
                const items = result.items.map(
                  i =>
                    new ReportLineItem(
                      i._stockName,
                      i._stockAmount,
                      new Money(i._price._amount, i._price._currency)
                    )
                );

                resolve(new Report(items, bank));
              });
            });
          }

          deleteReport() {
            return new Promise((resolve, reject) => {
              this._repository.destroy().then(() => {
                resolve();
              });
            });
          }
        }

        class ExChangeRateService {
          constructor(db) {
            this._repository = new ExChangeRateRepository(db, "exchange_rates");
          }

          get repository() {
            return this._repository;
          }

          selectAllExChangeRate() {
            return new Promise((resolve, reject) => {
              this._repository
                .connect()
                .then(() => {
                  this._repository
                    .selectAll()
                    .then(result => {
                      resolve(new ExChangeRates(result));
                    })
                    .catch(err => {
                      reject(err);
                    });
                })
                .catch(err => {
                  reject(err);
                });
            });
          }

          updateExChangeRate(from, to, rate, id) {
            return new Promise((resolve, reject) => {
              const entity = new ExChangeRate(from, to, rate, id);
              return this._repository.save(entity).then(() => {
                return this._repository.selectAll().then(result => {
                  resolve(new ExChangeRates(result));
                });
              });
            });
          }

          addExChangeRate(entity = new ExChangeRate("CHF", "USD", 1.5)) {
            return new Promise((resolve, reject) => {
              return this._repository.create(entity).then(() => {
                return this._repository.selectAll().then(result => {
                  resolve(new ExChangeRates(result));
                });
              });
            });
          }

          deleteExChangeRate(id) {
            return new Promise((resolve, reject) => {
              this._repository.delete(id).then(() => {
                this._repository.selectAll().then(result => {
                  resolve(new ExChangeRates(result));
                });
              });
            });
          }

          deleteAllExChangeRate() {
            return new Promise((resolve, reject) => {
              this._repository.destroy().then(() => {
                this._repository.selectAll().then(result => {
                  resolve(new ExChangeRates(result));
                });
              });
            });
          }
        }

        class MoneyServiceMock extends MoneyService {
          constructor() {
            super();
            const db = new MoneyDB("money_test", "TEMP");
            this._reportService = new ReportServiceMock(db);
            this._exChangeRateService = new ExChangeRateServiceMock(db);
          }
        }

        class ReportServiceMock extends ReportService {
          constructor(db) {
            super();
            this._repository = new ReportRepository(db, MoneyDB.REPORT);
          }
        }

        class ExChangeRateServiceMock extends ExChangeRateService {
          constructor(db) {
            super();
            this._repository = new ExChangeRateRepository(
              db,
              MoneyDB.EXCHANGE_RATES
            );
          }
        }

        class MoneyView {
          constructor() {
            this.REPORT = 1;
            this.EXCHANGE = 2;

            this._service = new MoneyService();
            this._report = new ReportView();
            this._exChangeRate = new ExChangeRateView();
            this._selectTab = this.REPORT;
            this._css = {
              id: {
                application: "money-app",
                section: {
                  menu: "menu"
                },
                message: MessageView.selectorId,
                tab_menus: {
                  name: "tab-menus",
                  no1: "tab-menu01",
                  no2: "tab-menu02"
                },
                panel_menus: {
                  name: "panel-menus",
                  no1: "panel-menu01",
                  no2: "panel-menu02"
                },
                report: {
                  name: "report",
                  upload: "app-money-upload",
                  download: "app-money-download",
                  table: "report-table"
                },
                exchange_rate: {
                  name: "exchange-rate",
                  table: "exchange-rate-table",
                  button: {
                    name: "exchange-rate-button",
                    add: "exchange-rate-button-add",
                    destroy: "exchange-rate-button-destroy",
                    edit: "exchange-rate-button-edit",
                    save: "exchange-rate-button-save",
                    delete: "exchange-rate-button-delete"
                  }
                }
              }
            };
            this._message = new MessageView();
            this._state = {
              reportSelect: "",
              exChangeSelect: ""
            };
            this._results = null;
          }

          dispatchEvent(css) {
            const selectReportTabEvent = e => {
              this._service.getReport().then(result => {
                this._results = null;
                this._selectTab = this.REPORT;
                this.render();
              });
            };

            const selectExChangeRateTabEvent = e => {
              this._service.selectAllExChangeRate().then(result => {
                this._results = null;
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            document
              .querySelector(`#${css.id.tab_menus.no1}`)
              .addEventListener("click", selectReportTabEvent);
            document
              .querySelector(`#${css.id.tab_menus.no2}`)
              .addEventListener("click", selectExChangeRateTabEvent);

            this._report.dispatchEvent.bind(this)(css);

            this._exChangeRate.dispatchEvent.bind(this)(css);
          }

          create(report, exChangeRate) {
            return new TabCompnent({
              report: report,
              exChangeRate: exChangeRate,
              css: this._css,
              state: {
                reportSelect: this._state.reportSelect,
                exChangeSelect: this._state.exChangeSelect
              }
            });
          }

          render() {
            this._state.reportSelect =
              this._selectTab === this.REPORT ? "active" : "";
            this._state.exChangeSelect =
              this._selectTab === this.EXCHANGE ? "active" : "";

            this._service.setUpDb().then(() => {
              this._service.getReport().then(data => {
                this._report = new ReportView(data, this._css);
                const report = this._report.render();

                this._service.selectAllExChangeRate().then(data => {
                  this._exChangeRate = new ExChangeRateView(data, this._css);
                  const exChangeRate = this._exChangeRate.render();

                  document.querySelector(
                    `#${this._css.id.application}`
                  ).innerHTML = this.create(report, exChangeRate).create();

                  this.dispatchEvent(this._css);

                  if (this._results !== null)
                    this._message.render(
                      this._results.message,
                      this._results.type
                    );
                });
              });
            });
          }
        }

        class ReportView {
          constructor(data, css) {
            this._report = data;
            this._css = css;
          }

          dispatchEvent(css) {
            const uploadEvent = e => {
              this._message.render(
                "レポートを生成しています...",
                MessageView.WARNING
              );

              if (
                window.File &&
                window.FileReader &&
                window.FileList &&
                window.Blob
              ) {
                const fileData = e.target.files[0];

                if (!fileData.name.match(".csv$")) {
                  alert("CSVファイルを選択してください");
                  return;
                }

                const reader = new FileReader();

                reader.onload = () => {
                  const data = reader.result;
                  const parseData = Papa.parse(data, {
                    header: true,
                    skipEmptyLines: true
                  });

                  this._service
                    .createReportViewModel(parseData.data)
                    .then(report => {
                      this._service
                        .saveReport(report)
                        .then(() => {
                          this._results = {
                            message: "レポートを読み込みました",
                            type: MessageView.SUCCESS
                          };

                          this._selectTab = this.REPORT;
                          this.render();
                        })
                        .catch(err => {
                          this._results = {
                            message: `レポートを読み込めませんでした:${err}`,
                            type: MessageView.DANGER
                          };

                          this._selectTab = this.REPORT;
                          this.render();
                        });
                    });
                };

                reader.readAsText(fileData, "utf-8");
              } else {
                alert("File APIに対応したブラウザでご確認ください");
              }
            };

            const downloadEvent = e => {
              const csv = Papa.unparse(this._report._report.items);
              const bom = new Uint8Array([0xef, 0xbb, 0xbf]);
              const blog = new Blob([bom, csv], { type: "text/csv" });
              const url = URL.createObjectURL(blog);
              const a = document.createElement("a");

              a.href = url;
              a.target = "_blank";
              a.download = "data.csv";

              a.click();

              this._message.render(
                "CSVファイルダウンロード完了しました",
                MessageView.SUCCESS
              );
            };

            document
              .querySelector(`#${css.id.report.upload}`)
              .addEventListener("change", uploadEvent);
            document
              .querySelector(`#${css.id.report.download}`)
              .addEventListener("click", downloadEvent);
          }

          create() {
            return reportSelect => {
              const activeShow = reportSelect ? "active show" : "";

              const table = () => {
                const header = () => {
                  const line = ["銘柄", "株数", "価格", "合計"]
                    .map(i => `<th>${i}</th>`)
                    .join(" ");

                  return `
                                  <thead>
                                    <tr>
                                      ${line}
                                    </tr>
                                  </thead>
                            `;
                };

                const body = () => {
                  const items = this._report.items;
                  const line = items
                    .map(
                      i => `
                            <tr>
                              <td>${i.stockName}</td>
                              <td>${i.stockAmount}</td>
                              <td>${i.price}</td>
                              <td>${i.sum}</td>
                            </tr>
                            `
                    )
                    .join(" ");
                  const total = `
                                    <tr>
                                      <td></td>
                                      <td></td>
                                      <td>
                                        <p>総計</p>
                                      </td>
                                      <td>
                                        <p>${this._report.total}</p>
                                      </td>
                                    </tr>
                            `;
                  return `
                                  <tbody>
                                    ${line}
                                    ${total}
                                  </tbody>
                            `;
                };

                const component = new TableComponent(
                  this._css.id.report.table,
                  header,
                  body
                );

                return component.create();
              };

              const upload = () => {
                const button = new FileInputComponent(
                  this._css.id.report.upload
                );
                return `
                                <div class="col-md-12">
                                  <form>
                                    <div class="form-group">
                                      <p>
                                        CSVファイルを選択して下さい。<br />
                                      </p>
                                      ${button.create()}
                                    </div>
                                  </form>
                                </div>
                          `;
              };

              const download = () => {
                const button = new PrimaryButtonComponent(
                  this._css.id.report.download,
                  "CSVダウンロード"
                );

                return button.create();
              };

              return `
                        <div
                          aria-labelledby="tab-menu01"
                          class="tab-pane fade border border-top-0 ${activeShow}"
                          id=${this._css.id.panel_menus.no1}
                          role="tabpanel"
                        >
                          <dvi class="row p-3">
                            <div id=${
                              this._css.id.report.name
                            } class="col-md-12 order-md-2">
                              <div class="row">
                                ${upload()}
                              </div>
                              <div class="row">
                                ${table()}
                              </div>
                              <div class="col-md-12 py-2">
                                ${download()}
                              </div>
                            </div>
                          </dvi>
                        </div>
                    `;
            };
          }

          render() {
            return this.create();
          }
        }

        class ExChangeRateView {
          constructor(data, css) {
            this._record = data;
            this._css = css;
          }

          dispatchEvent(css) {
            const addExChangeRateEvent = e => {
              this._service.addExChangeRate().then(data => {
                this._results = {
                  message: "為替レートを追加しました",
                  type: MessageView.SUCCESS
                };
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            const editExChangeRateEvent = e => {
              e.target.disabled = true;
              e.target.parentElement.getElementsByTagName(
                "button"
              )[1].disabled = false;

              const from = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "td"
              )[1];
              const to = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "td"
              )[2];
              const rate = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "td"
              )[3];

              const fromInput = new TextInputComponent("", 10, from.innerText);
              const toInput = new TextInputComponent("", 10, to.innerText);
              const rateInput = new TextInputComponent("", 10, rate.innerText);
              from.innerHTML = fromInput.create();
              to.innerHTML = toInput.create();
              rate.innerHTML = rateInput.create();
            };

            const saveExChangeRateEvent = e => {
              const from = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[0];
              const to = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[1];
              const rate = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[2];
              const id = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[3].value;

              this._service
                .updateExChangeRate(from.value, to.value, rate.value, id)
                .then(result => {
                  this._results = {
                    message: "為替レートを保存しました",
                    type: MessageView.SUCCESS
                  };
                  this._selectTab = this.EXCHANGE;
                  this.render();
                });
            };

            const deleteAllExChangeRateEvent = e => {
              this._service.deleteAllExChangeRate().then(() => {
                this._results = {
                  message: "為替レートを全て削除しました",
                  type: MessageView.WARNING
                };
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            const delteExhangeRateEvent = e => {
              const id = e.target.parentElement.parentElement.parentElement.getElementsByTagName(
                "input"
              )[0].value;

              this._service.deleteExChangeRate(id).then(() => {
                this._results = {
                  message: "為替レートを削除しました",
                  type: MessageView.WARNING
                };
                this._selectTab = this.EXCHANGE;
                this.render();
              });
            };

            document
              .querySelector(`#${css.id.exchange_rate.button.add}`)
              .addEventListener("click", addExChangeRateEvent);
            document
              .querySelector(`#${css.id.exchange_rate.button.destroy}`)
              .addEventListener("click", deleteAllExChangeRateEvent);
            this._exChangeRate._record._record.forEach((v, k) => {
              document
                .querySelector(`#${css.id.exchange_rate.button.edit}-${k}`)
                .addEventListener("click", editExChangeRateEvent);
              document
                .querySelector(`#${css.id.exchange_rate.button.save}-${k}`)
                .addEventListener("click", saveExChangeRateEvent);
              document.querySelector(
                `#${css.id.exchange_rate.button.save}-${k}`
              ).disabled = true;
              document
                .querySelector(`#${css.id.exchange_rate.button.delete}-${k}`)
                .addEventListener("click", delteExhangeRateEvent);
            });
          }

          create() {
            return exChangeSelect => {
              const activeShow = exChangeSelect ? "active show" : "";

              const table = record => {
                const header = () => {
                  const th = ["ID", "換算元", "換算先", "レート", ""]
                    .map(i => `<th>${i}</th>`)
                    .join(" ");

                  return `
                                <thead>
                                  <tr>
                                    ${th}
                                  </tr>
                                </thead>
                            `;
                };

                const body = () => {
                  const line = (item, key) => {
                    const edit = () => {
                      const button = new PrimaryMiniButtonComponent(
                        `${this._css.id.exchange_rate.button.edit}-${key}`,
                        "編集"
                      );
                      return button.create();
                    };

                    const save = () => {
                      const button = new PrimaryMiniButtonComponent(
                        `${this._css.id.exchange_rate.button.save}-${key}`,
                        "保存"
                      );
                      return button.create();
                    };

                    const delet = () => {
                      const button = new DangerMiniButtonComponent(
                        `${this._css.id.exchange_rate.button.delete}-${key}`,
                        "削除"
                      );
                      return button.create();
                    };

                    return `
                                  <tr>
                                    <td>${item.id.slice(0, 5)}...</td>
                                    <td>${item.from}</td>
                                    <td>${item.to}</td>
                                    <td>${item.rate}</td>
                                    <td>
                                      <span class="button">
                                        ${edit()}
                                        ${save()}
                                        ${delet()}
                                      </span>
                                    </td>
                                    <td>
                                      <input type="hidden" value=${item.id}>
                                    </td>
                                  </tr>
                              `;
                  };

                  return `
                                <tbody>
                                  ${record.map((v, k) => line(v, k)).join("")}
                                </tbody>
                            `;
                };

                const component = new TableComponent(
                  this._css.id.exchange_rate.table,
                  header,
                  body
                );

                return component.create();
              };

              const button = () => {
                const add = () => {
                  const button = new PrimaryMiniButtonComponent(
                    this._css.id.exchange_rate.button.add,
                    "追加"
                  );
                  return button.create();
                };

                const deletAll = () => {
                  const button = new DangerMiniButtonComponent(
                    this._css.id.exchange_rate.button.destroy,
                    "全削除"
                  );
                  return button.create();
                };
                return `
                              <div id="button">
                                ${add()}
                                ${deletAll()}
                              </div>
                          `;
              };

              return `
                        <div
                          aria-labelledby="tab-menu02"
                          class="tab-pane fade border border-top-0 ${activeShow}"
                          id=${this._css.id.panel_menus.no2}
                          role="tabpanel"
                        >
                          <dvi class="row p-3">
                            <div id="exchange-rate" class="col-md-12 order-md-2">
                              ${table(this._record._record)}
                              ${button()}
                            </div>
                          </dvi>
                        </div>
                    `;
            };
          }

          render() {
            return this.create();
          }
        }

        class TabCompnent {
          constructor(params) {
            this._css = params.css;
            this._report = params.report;
            this._exChangeRate = params.exChangeRate;
            this._state = params.state;
          }

          create() {
            const tabNav = `
                      <div class="nav nav-tabs" id=${this._css.id.tab_menus.name} role="tablist">
                        <a
                          aria-controls="panel-menu01"
                          aria-selected="true"
                          class="nav-item nav-link ${this._state.reportSelect}"
                          data-toggle="tab"
                          href="#panel-menu01"
                          id=${this._css.id.tab_menus.no1}
                          role="tab"
                          >レポート</a
                        >
                        <a
                          aria-controls="panel-menu02"
                          aria-selected="false"
                          class="nav-item nav-link ${this._state.exChangeSelect}"
                          data-toggle="tab"
                          href="#panel-menu02"
                          id=${this._css.id.tab_menus.no2}
                          role="tab"
                          >為替レート</a
                        >
                      </div>
                  `;

            const tabContent = (report, exChangeRate) => {
              return `
              <div class="tab-content" id=${this._css.id.panel_menus.name}>
                ${report(this._state.reportSelect)}
                ${exChangeRate(this._state.exChangeSelect)}
              </div>
              `;
            };

            return `
              <section id=${this._css.id.section.menu}>
                <div class="container">
                  <div id=${this._css.id.message}></div>
                  ${tabNav}
                  ${tabContent(this._report, this._exChangeRate)}
                </div>
              </section>
            `;
          }
        }

        class TableComponent {
          constructor(id, header, body) {
            this._id = id;
            this._header = header;
            this._body = body;
          }

          create() {
            return `
                    <table id=${this._id} class="table table-striped">
                        ${this._header()}
                        ${this._body()}
                    </table>
                  `;
          }
        }

        class ButtonComponent {
          constructor(id, label, style = "btn") {
            this._id = id;
            this._label = label;
            this._style = style;
          }

          create() {
            return `
                        <button
                          type="button"
                          class="${this._style}"
                          id="${this._id}"
                        >
                        ${this._label}
                        </button>
                  `;
          }
        }

        class PrimaryButtonComponent extends ButtonComponent {
          constructor(id, label) {
            super(id, label, "btn btn-primary");
          }
        }

        class PrimaryMiniButtonComponent extends ButtonComponent {
          constructor(id, label) {
            super(
              id,
              label,
              "btn btn-primary btn-rounded btn-sm my-0 waves-effect waves-light"
            );
          }
        }

        class DangerMiniButtonComponent extends ButtonComponent {
          constructor(id, label) {
            super(
              id,
              label,
              "btn btn-danger btn-rounded btn-sm my-0 waves-effect waves-light"
            );
          }
        }

        class InputComponent {
          constructor(id, type, style, size, value) {
            this._id = id;
            this._type = type;
            this._sytle = style;
            this._size = size;
            this._value = value;
          }

          create() {
            return `
              <input
                value="${this._value}"
                size="${this._size}"
                type="${this._type}"
                class="${this._sytle}"
                id=${this._id}
              />
           `;
          }
        }

        class FileInputComponent extends InputComponent {
          constructor(id) {
            super(id, "file", "form-control-file");
          }
        }

        class TextInputComponent extends InputComponent {
          constructor(id, size, value) {
            super(id, "text", "", size, value);
          }
        }

        class MessageView {
          constructor() {}

          static get WARNING() {
            return 1;
          }

          static get SUCCESS() {
            return 2;
          }

          static get DANGER() {
            return 3;
          }

          static get selectorId() {
            return "app__message";
          }

          static create(message, type) {
            switch (type) {
              case 1:
                return `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
              `;
              case 2:
                return `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
              `;
              case 3:
                return `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
              `;
              default:
                return `
                    <div class="alert alert-primary alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
              `;
            }
          }

          clear() {
            document.querySelector(`#${MessageView.selectorId}`).innerHTML = "";
          }

          render(message, type) {
            document.querySelector(
              `#${MessageView.selectorId}`
            ).innerHTML = MessageView.create(message, type);
          }
        }

        const view = new MoneyView();
        view.render();
      </script>
      <script>
        mocha.globals(["jQuery"]);
        mocha.run();
      </script>
    </div>
  </body>
</html>
